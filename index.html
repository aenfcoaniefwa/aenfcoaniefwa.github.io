<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toronto 3D - Vegetation Encroachment Analysis</title>
  
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
    body { font-family: 'Segoe UI', Arial, sans-serif; }
    
    /* ë²”ë¡€ ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      cursor: pointer;
      padding: 2px 0;
    }
    .legend-item:hover {
      background-color: rgba(0,0,0,0.05);
      border-radius: 4px;
    }
    .legend-checkbox {
      margin-right: 8px;
      cursor: pointer;
      width: 16px;
      height: 16px;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.111/Build/Cesium/Cesium.js"></script>
  
  <script>
    // ============================================================
    // 1. Cesium ì´ˆê¸°í™”
    // ============================================================
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIxYjdlMzQ0MS0yN2ZkLTRmN2YtOTQyNS03NzJmZjhiNThiNWMiLCJpZCI6MzU3MzAyLCJpYXQiOjE3NjIzMjY0MDB9.g8X6QOBkBlUd19ThMkr5mQySkylzEMhJbLLP3XcVtJA'; 
    
    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      selectionIndicator: false,
      infoBox: false,
      timeline: false,
      animation: false,
      baseLayerPicker: true,
      geocoder: true,
      homeButton: true,
      sceneModePicker: true,
      navigationHelpButton: true,
      fullscreenButton: true,
    });
    
    // ============================================================
    // 2. ìƒíƒœ ê´€ë¦¬ (ê°€ì‹œì„± ë° í¬ì¸íŠ¸ í¬ê¸°)
    // ============================================================
    const appState = {
      pointSize: 3,
      visibility: {
        highRisk: true,  // Vegetation Red
        safe: true,      // Vegetation Green
        powerLine: true, // Class 5
        pole: true       // Class 6
      }
    };

    let tileset;

    // ============================================================
    // 3. ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í•µì‹¬ ë¡œì§)
    // ============================================================
    function updateTilesetStyle() {
      if (!tileset) return;

      // ì¡°ê±´ì„ ë‹´ì„ ë°°ì—´
      let conditions = [];

      // 1) High Risk (Red): Class 3ì´ë©´ì„œ ë¹¨ê°„ìƒ‰ ì„±ë¶„ ìš°ì„¸
      if (appState.visibility.highRisk) {
        conditions.push("(${Classification} === 3 && ${COLOR}.red > ${COLOR}.green)");
      }

      // 2) Safe (Green): Class 3ì´ë©´ì„œ ì´ˆë¡ìƒ‰ ì„±ë¶„ ìš°ì„¸
      if (appState.visibility.safe) {
        conditions.push("(${Classification} === 3 && ${COLOR}.green >= ${COLOR}.red)");
      }

      // 3) Power Line: Class 5
      if (appState.visibility.powerLine) {
        conditions.push("${Classification} === 5");
      }

      // 4) Pole: Class 6
      if (appState.visibility.pole) {
        conditions.push("${Classification} === 6");
      }

      // ì¡°ê±´ë“¤ì„ OR (||) ì—°ì‚°ìë¡œ ê²°í•©. ì¡°ê±´ì´ ì—†ìœ¼ë©´ 'false'(ëª¨ë‘ ìˆ¨ê¹€)
      const showExpression = conditions.length > 0 ? conditions.join(" || ") : "false";

      // ìŠ¤íƒ€ì¼ ì ìš©
      tileset.style = new Cesium.Cesium3DTileStyle({
        pointSize: appState.pointSize,
        show: showExpression
      });
    }

    // ============================================================
    // 4. Asset ë¡œë“œ
    // ============================================================
    const assetId = 4134077;
    
    (async () => {
      try {
        tileset = await Cesium.Cesium3DTileset.fromIonAssetId(assetId);
        
        // ì´ˆê¸° ì‰ì´ë”© ì„¤ì •
        tileset.pointCloudShading.attenuation = true;
        tileset.pointCloudShading.maximumAttenuation = 4;
        tileset.pointCloudShading.baseResolution = 0.1;
        tileset.pointCloudShading.eyeDomeLighting = true;
        
        viewer.scene.primitives.add(tileset);
        viewer.zoomTo(tileset);
        
        // ì´ˆê¸° ìŠ¤íƒ€ì¼ ì ìš©
        updateTilesetStyle();
        
        console.log("âœ… 3D Tileset ë¡œë“œ ë° ìŠ¤íƒ€ì¼ ì ìš© ì™„ë£Œ!");
      } catch (error) {
        console.error(`Asset ë¡œë“œ ì‹¤íŒ¨: ${error}`);
      }
    })();
    
    // ============================================================
    // 5. UI: ë‚˜ì¹¨ë°˜
    // ============================================================
    const compassHTML = `
    <div id="compass" style="
      position: absolute; top: 10px; left: 10px; width: 80px; height: 80px;
      background: rgba(255, 255, 255, 0.9); border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex;
      align-items: center; justify-content: center; font-size: 24px;
      font-weight: bold; z-index: 1000; border: 3px solid #333;
    ">
      <div id="compassNeedle" style="
        position: absolute; width: 0; height: 0;
        border-left: 8px solid transparent; border-right: 8px solid transparent;
        border-bottom: 35px solid red; transform-origin: center bottom;
        bottom: 50%; transition: transform 0.3s ease;
      "></div>
      <div style="color: #333; position: absolute; top: 5px;">N</div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', compassHTML);
    
    viewer.camera.changed.addEventListener(() => {
      const headingDegrees = Cesium.Math.toDegrees(viewer.camera.heading);
      document.getElementById('compassNeedle').style.transform = `rotate(${-headingDegrees}deg)`;
    });
    
    // ============================================================
    // 6. UI: ë²”ë¡€ (í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€ë¨)
    // ============================================================
    const legendHTML = `
    <div id="legendContainer" style="position: absolute; top: 100px; left: 10px; z-index: 1000;">
      <button id="legendToggle" style="
        background: rgba(50, 150, 250, 0.9); color: white; border: none;
        padding: 10px 15px; border-radius: 5px; cursor: pointer;
        font-weight: bold; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        margin-bottom: 5px; width: 100%;
      ">ğŸ“Š ë²”ë¡€ ë° í•„í„°</button>

      <div id="legendPanel" style="
        background: rgba(255, 255, 255, 0.95); padding: 15px 20px;
        border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; min-width: 240px;
      ">
        <div style="font-size: 16px; font-weight: bold; margin-bottom: 12px; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
          ğŸŒ³ Vegetation Analysis
        </div>
        
        <div style="margin-bottom: 15px;">
          <div style="font-weight: bold; color: #34495e; margin-bottom: 8px; font-size: 12px;">VEGETATION (Class 3)</div>
          
          <label class="legend-item">
            <input type="checkbox" class="legend-checkbox" id="chkSafe" checked>
            <div style="width: 20px; height: 20px; background: #ff0000; border-radius: 3px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2);"></div>
            <span style="color: #555;">High Risk (< 3.0m)</span>
          </label>
          
          <label class="legend-item">
            <input type="checkbox" class="legend-checkbox" id="chkHighRisk" checked>
            <div style="width: 20px; height: 20px; background: #00ff00; border-radius: 3px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2);"></div>
            <span style="color: #555;">Safe (â‰¥ 3.0m)</span>
          </label>
        </div>
        
        <div style="border-top: 1px solid #ddd; padding-top: 12px; margin-top: 12px;">
          <div style="font-weight: bold; color: #34495e; margin-bottom: 8px; font-size: 12px;">INFRASTRUCTURE</div>
          
          <label class="legend-item">
            <input type="checkbox" class="legend-checkbox" id="chkPowerLine" checked>
            <div style="width: 20px; height: 20px; background: #0000ff; border-radius: 3px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2);"></div>
            <span style="color: #555;">Power Line (Class 5)</span>
          </label>
          
          <label class="legend-item">
            <input type="checkbox" class="legend-checkbox" id="chkPole" checked>
            <div style="width: 20px; height: 20px; background: #808080; border-radius: 3px; margin-right: 10px; border: 1px solid rgba(0,0,0,0.2);"></div>
            <span style="color: #555;">Pole (Class 6)</span>
          </label>
        </div>
        
        <div style="margin-top: 12px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 11px; color: #7f8c8d; text-align: center;">
          Safety Buffer: 3.0m (Ontario ESA)
        </div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', legendHTML);

    // ë²”ë¡€ í† ê¸€ UI ì´ë²¤íŠ¸
    const legendToggle = document.getElementById('legendToggle');
    const legendPanel = document.getElementById('legendPanel');
    let legendVisible = true;
    legendToggle.addEventListener('click', () => {
      legendVisible = !legendVisible;
      legendPanel.style.display = legendVisible ? 'block' : 'none';
    });

    // ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.getElementById('chkHighRisk').addEventListener('change', (e) => {
      appState.visibility.highRisk = e.target.checked;
      updateTilesetStyle();
    });
    document.getElementById('chkSafe').addEventListener('change', (e) => {
      appState.visibility.safe = e.target.checked;
      updateTilesetStyle();
    });
    document.getElementById('chkPowerLine').addEventListener('change', (e) => {
      appState.visibility.powerLine = e.target.checked;
      updateTilesetStyle();
    });
    document.getElementById('chkPole').addEventListener('change', (e) => {
      appState.visibility.pole = e.target.checked;
      updateTilesetStyle();
    });

    // ============================================================
    // 7. UI: ì¶•ì²™ ë° í¬ì¸íŠ¸ ì„¤ì •
    // ============================================================
    const controlsHTML = `
    <div style="position: absolute; bottom: 30px; right: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end;">
      
      <div id="pointSizeContainer" style="margin-bottom: 10px;">
        <button id="pointSizeToggle" style="
          background: rgba(50, 150, 250, 0.9); color: white; border: none; padding: 10px 15px;
          border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3); width: 140px;
        ">ğŸ¨ í¬ì¸íŠ¸ ì„¤ì •</button>
        <div id="pointSizePanel" style="
          background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-family: 'Segoe UI', Arial, sans-serif;
          font-size: 13px; margin-top: 5px; width: 200px;
        ">
          <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">ğŸ“ í¬ì¸íŠ¸ í¬ê¸°</div>
          <input type="range" id="pointSizeSlider" min="1" max="10" value="3" step="0.5" style="width: 100%; margin-bottom: 5px;">
          <div style="text-align: center; color: #555;"><span id="pointSizeValue">3</span> px</div>
          <hr style="border: none; border-top: 1px solid #ddd; margin: 12px 0;">
          <div style="font-weight: bold; margin-bottom: 10px; color: #2c3e50;">ğŸ’¡ Eye-Dome Lighting</div>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="edlToggle" checked style="margin-right: 8px;">
            <span style="color: #555;">ê¹Šì´ê° í–¥ìƒ</span>
          </label>
        </div>
      </div>

      <div id="scaleBar" style="
        background: rgba(255, 255, 255, 0.9); padding: 10px 15px; border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3); font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px;
      ">
        <div style="width: 100px; height: 3px; background: #333; margin-bottom: 5px; position: relative;">
          <div style="position: absolute; left: 0; top: -5px; width: 2px; height: 13px; background: #333;"></div>
          <div style="position: absolute; right: 0; top: -5px; width: 2px; height: 13px; background: #333;"></div>
        </div>
        <div id="scaleText" style="text-align: center; font-weight: bold; color: #333;">0 m</div>
      </div>
    </div>`;
    document.body.insertAdjacentHTML('beforeend', controlsHTML);

    // í¬ì¸íŠ¸ ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
    const pointSizeToggle = document.getElementById('pointSizeToggle');
    const pointSizePanel = document.getElementById('pointSizePanel');
    let pointSizeVisible = true;
    pointSizeToggle.addEventListener('click', () => {
      pointSizeVisible = !pointSizeVisible;
      pointSizePanel.style.display = pointSizeVisible ? 'block' : 'none';
    });

    document.getElementById('pointSizeSlider').addEventListener('input', (e) => {
      appState.pointSize = parseFloat(e.target.value);
      document.getElementById('pointSizeValue').textContent = appState.pointSize;
      updateTilesetStyle(); // ìŠ¤íƒ€ì¼ ì¬ì ìš© (ê°€ì‹œì„± ìœ ì§€í•˜ë©° í¬ê¸° ë³€ê²½)
    });

    document.getElementById('edlToggle').addEventListener('change', (e) => {
      if (tileset) tileset.pointCloudShading.eyeDomeLighting = e.target.checked;
    });

    // ì¶•ì²™ ì—…ë°ì´íŠ¸ ë¡œì§
    viewer.camera.changed.addEventListener(() => {
      const scaleText = document.getElementById('scaleText');
      const canvas = viewer.scene.canvas;
      const width = canvas.clientWidth;
      const left = viewer.camera.pickEllipsoid(new Cesium.Cartesian2(width/2 - 50, canvas.clientHeight/2));
      const right = viewer.camera.pickEllipsoid(new Cesium.Cartesian2(width/2 + 50, canvas.clientHeight/2));
      if (left && right) {
        const dist = Cesium.Cartesian3.distance(left, right);
        scaleText.textContent = dist < 1000 ? `${dist.toFixed(0)} m` : `${(dist/1000).toFixed(1)} km`;
      }
    });

    // ì¹´ë©”ë¼ ì´ˆê¸° ìœ„ì¹˜
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(-79.3832, 43.6532, 500),
      orientation: { heading: 0, pitch: Cesium.Math.toRadians(-45), roll: 0 }
    });
    
    viewer.scene.postProcessStages.fxaa.enabled = true;
  </script>
</body>
</html>
